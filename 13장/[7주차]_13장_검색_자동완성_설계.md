> 가장 많이 이용된 검색어 k개를 자동완성 출력 하는 시스템을 설계해보자


## 앞서서
- `dinner`를 입력 하면 `d`, `di`, `din`, `dinn`, `dinne`, `dinner` 를 순차적으로 검색한다
- 이 경우, 추천 키워드가 정말 많은데, 정렬을 위한 우선순위가 필요하다
	- 이번 설계에선, 자주 검색된([검색]을 누른 키워드인듯?) 키워드를 내림차순 출력하자


# 검색 우선순위는 어떻게 저장해야 할까?

- 키워드를 prefix 부터 차례대로 내려가는 "트라이" 자료구조를 사용한다

#### 트라이 자료구조란
- 대충 트리랑 비슷한데, 자식이 쥰내가 많아도 된다
	- 우리 상황에선, 영어 키워드 기준, 각 노드의 자식은 최대 26개가 된다(알파벳 개수)
	- ex) 단어 "trio"는 "t" 노드 - "tr" 노드 - "tri" 노드 - "trio" 노드에 위치한다

##### 시간 복잡도
- 길이가 p 짜리 접두어 위치를 찾는 경우 = O(p)
- 해당 접두어 하위 모든 유효 노드를 찾는 경우 = O(c) (c는 해당 접두어 하위의 노드 수)
- 유효 노드들을 정렬하여 상위 k개를 찾는 경우 O(clogc)

- 사용자가 특정 키워드 (예시로 "su"를 들어보자)의 연관 검색어를 찾는데에는
	1. 해당 노드("su") 를 찾고
	2. 해당 하위 노드의 모든 유효 노드("sun", "sunny", "super", ....)를 찾고
	3. 모든 유효 값을 frequency를 기준, 정렬하여 상위 k개만 도출한다

> p값이 너무 크다면? 제한하자!
> 어차피 50자씩 검색해서, 유효한 연관 검색어를 찾길 원하는 사용자는 없다!
> 이 경우, O(p) 는 O(1) 으로 수렴할 수 있다


##### 최적화를 해보자

- 각 노드 별로, 하위 키워드 중 상위 k개를 캐싱해서 저장해 놓으면, 훨씬 빠르겠다
	- 이러면 특정 키워드의 연관 검색어를 찾아내는 과정이 O(1)로 수렴한다 (상위 k개가 작다는 가정)



# 데이터를 그러면 어떻게 모아올까?

> 구글과 같은 서비스는 검색 연관성의 실시간성을 높게 요구하지 않는다. 그러면, 실시간으로 트리를 재구성하기보단, 주기적으로 한번에 하는게 낫지 않을까?


### 로그 데이터 수집
- 로그를 수집해서 이를 주기적으로(책에서는 일주일) 트리를 최신화 하는 방식이다
- 로그 수집 -> 트라이 DB 주기적 최신화 -> 매주 스냅샷을 떠, 캐싱
```
만약, 대규모 서비스라서, 쌓이는 로그가 너무 많다면, "데이터 샘플링" 이라는 기법을 통해, 그 일부분만 수집할 수 있다.

랜덤하게, 일정기간마다, 등 다양한 방식이 있겠다

```
#### 트라이 DB
- 문서 저장소: 직렬화
- 키-값 저장소: p.240 - 해싱

##### 어떻게 만들까?
- 일주일에 한번씩, 로그를 기반으로, 새로 트라이를 만든다
- 만약, 추가 사항만 가지고 변경될 노드만 손대는 방식을 생각할 수 있다. 트라이가 작으면 좋겠지만, 하나의 노드 수정에, 상위 모든 노드가 수정될 수 있음을 기억하자!


### 최적화, 최적화!

- AJAX: 몰라? 아무튼 이걸 쓰면 브라우저가 새로고침이 안된다~~ 이유는 준엽이가 알려줘라
- 브라우저 캐싱: 어차피 일주일에 한번씩 최신화 하는 마당에, 똑같은 검색어를 친다고, 매번 요청을 보낼 필요가 없다. 구글은, 1시간의 alive를 두어 브라우저에 캐싱해두도록 한다

- 검색어 필터: 혐오스러운(~~시발~~ 같은) 단어는 필터로, 추출되지 않도록 하자. 그래도 소중한 데이터라서 로그 수집은 하는 듯?


# 샤딩!
- 너무 비대해진 트라이, 어떻게 보관할까?
- a ~ z 로 시작하는 트라이를 각각 보관하면 최대 26대까지 늘릴 수 있다.
- 더 늘리고 싶다면? 더 효율적으로 하고 싶다면? 
	- a로 시작하는 단어 500만개, b~z로 시작하는 단어 10개 라고 하자
	- a 샤드 하나, b~z 샤드 하나로 우선 나누고, 이를 매니징 할 수 있는 정보를 별도의 저장소에 두자.
	- 이제 매니저한테 물어봐서 원하는 DB에서 꺼내면 된다!



# 앞으로 뭘 더 고민할까용

- 영어가 아니라면? -> 유니코드를 쓰세용!
- 국가별 차별화는? -> 국가별로 트라이를 만드세용! (트라이는 cdn)
- 트위터 / 뉴스처럼 핫한 키워드는? -> 니가 찾아보세용!
