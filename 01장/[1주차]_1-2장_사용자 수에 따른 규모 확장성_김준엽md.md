# 캐시

캐시란?
=> 복잡한 연산이나 시간이 오래 걸리는 연산을 미리 수행/저장해서 빨리 가져와서 쓸수 있게 하는 것

_캐시의 종류_

- 로컬캐시
- DB 내부 캐시
- **`CDN`**
- in-memory 캐시 (redis, memcached)

**그러면 항상 캐시를 사용하는 것이 좋을까?**

- 데이터가 변경에 예민한가?
- 연산이 비싼가?
- 데이터의 변경이 전파가 되나? (이를 캐시의 정합성이라고 표현한다.)

### 캐시의 전략

읽기 주도형 캐시 전략

1. 요청을 받은 웹서버는 캐시에 응답이 저장되어 있는지를 본다.
2. 저장되어 있다면 해당 데이터를 전달
3. 없다면 DB에 쿼리문을 통해 데이터를 전달

더 다양한 캐시 전략을 알고 싶다면
https://inpa.tistory.com/entry/REDIS-%F0%9F%93%9A-%EC%BA%90%EC%8B%9CCache-%EC%84%A4%EA%B3%84-%EC%A0%84%EB%9E%B5-%EC%A7%80%EC%B9%A8-%EC%B4%9D%EC%A0%95%EB%A6%AC

**캐시 사용시 유의할 점**

1. 데이터 갱신은 자주 일어나지 않지만 조회가 자주 일어나는 경우 캐시 도입을 고민
2. 휘발성 데이터를 넣어두는 것이 좋다.
3. 캐시의 데이터 만료시기를 정해두어야 한다.
4. 캐시의 정합성 문제 (DB의 데이터와 캐시의 데이터가 일치해야한다.)
5. 캐시 서버가 하나일 경우에 캐시서버의 다운 가능성도 염두해두어야 한다.
6. 캐시 메모리의 크기를 얼마나 잡을 것인가?
7. 캐시의 교환정책(LRU, LFU 등)

# CDN(콘텐츠 전송 네트워크)

우리가 해외의 다양한 매체들 (넷플릭스 등) 매우 큰 동영상 파일을 어떻게 빠르게 스트리밍이 가능할까? 이는 CDN 사진, 이미지, JS, 동영상 파일과 같은 정적 데이터들을 캐시해두고 용량이 큰 파일을 캐시서버로 빠르게 제공해주는 서비스이다.

동적 컨텐츠를 제공하는 CDN도 있다고 한다.

![[Pasted image 20240105213127.png]]
\*CDN사용시 고려사항

- 비용 (자주 사용하지 않는 파일을 캐싱하면 비용이 오히려 올라간다)
- TTL 설정
- CDN 서버가 다운됐을 시에 대비 사항도 준비해야한다.

### 동적 컨텐츠 CDN

웹페이지에서 동적 컨텐츠는 무엇을 말하는 것일까?
인터넷 기사와 유튜브를 대표로 들 수 있다. 특히 유튜브는 사용자의 알고리즘에 따라 추천하는 영상들이 수시로 바뀌므로 이는 동적 컨텐츠의 대표적인 예시다. 동적 컨텐츠는 어떻게 캐싱 할 수 있는지 간단하게만 알아보자.

동적 웹 페이지는 정적 HTML 파일로 저장되지 않습니다. 대신, [서버 측](https://www.cloudflare.com/learning/serverless/glossary/client-side-vs-server-side/) 스크립트가 사용자 상호작용 또는 사용자 로그인 등의 이벤트에 대한 응답으로 HTML 파일을 생성하고 이를 웹 브라우저로 전송합니다. 동적 콘텐츠는 서버 측에서 생성되기 때문에 캐시가 아니라 [원본 서버](https://www.cloudflare.com/learning/cdn/glossary/origin-server/)에서 제공되는 것이 일반적입니다.

이러한 동적 콘텐츠는 오랫동안 캐시할 수 없는 것으로 간주되었습니다. 하지만 새로운 기술을 이용하면 웹 사이트가 캐시에서 동적 콘텐츠를 제공할 수 있게 되어 사용자에게 대화식 환경을 제공하면서도 [대기 시간](https://www.cloudflare.com/learning/performance/glossary/what-is-latency/) 을 크게 줄일 수 있습니다.
(cloudflare 출처)

<동적 컨텐츠의 캐싱 방식>
동적 콘텐츠는 페이지의 콘텐츠를 작성하는 스크립트에 의해 생성됩니다. 멀리 떨어져 있는 서버가 아닌 CDN 캐시에서 스크립트를 실행함으로써 캐시에서 동적 콘텐츠를 생성하고 전송할 수 있습니다. 그러므로 동적 콘텐츠도 본질적으로 "캐싱된" 것이며 원본에서부터 제공할 필요가 없어지므로 클라이언트 요청에 대한 응답 시간이 줄어들고 동적 웹 페이지를 가속화할 필요도 없어집니다.

예를 들어, [Cloudflare Workers](https://www.cloudflare.com/products/cloudflare-workers/)는 Cloudflare CDN에서 실행되는 [서버리스 JavaScript 함수](https://www.cloudflare.com/learning/serverless/glossary/function-as-a-service-faas/)로서 장치 유형, 하루 중 시간대, 사용자 위치, 타사 API에서의 데이터 등 다양한 이벤트 및 입력에 응답할 수 있습니다. 이러한 매개변수들에 따라 동적 콘텐츠가 생성되어 클라이언트 장치에 제공할 수 있으며 캐시의 정적 콘텐츠를 변경, 캐시, 제거할 수 있도록 지원합니다.

=> 간단하게 표현하면 동적 컨테츠의 생성은 JS에 함수의 실행으로 인해 생성되니, 이러한 JS의 실행자체를 CDN에서 실행하는 유사 캐싱 방식을 활용한다.

# 무상태 웹 계층

무상태 웹 계층이란 사용자의 세션 정보와 같은 상태 데이터를 웹 계층에서 제거해야한다. (그래야 수평적 확장이 가능하기 떄문에 MSA와 같은)

그래서 상태 정보를 따로 관리하는 DB에 저장하여 필요할 때 가져오도록 만드는 것을 _무상태 웹 계층이라 한다._

### 상태 의존적인 아키텍쳐

![[Pasted image 20240105213608.png]]
다음과 같은 서버에서는 각 서버마다 상태를 가지고 있기 때문에, 이 경우 각 서버의 수평적인 확장이 불가능하다. 그러므로 이러한 세션데이터나 프로파일 이미지를 한 저장소에 저장해두고 이를 각 서버에서 필요할 때 가져오는 아키텍처가 더욱 유리하다.

### 무상태 아키텍처

![[Pasted image 20240105213812.png]]
다음과 같이 여러개의 웹서버가 있어도 공유저장소는 하나이기 때문에 서버의 수평적인 확장이 가능하며 로드벨런서의 부담도 감소하는 추가적인 효과를 얻을 수 있다.

하지만 만약에 넷플릭스, 구글과 같은 전 세계사람들이 사용하는 서비스에서는 수평적으로 서버를 확장만 한다고 모든 전 세계의 유저가 쾌적하게 서비스 이용이 가능할까?
=>
이는 지리적 문제 때문에 서버의 위치가 사용자에 멀면 속도가 느리게 될 것이다. 이를 위해 `데이터 센터
를 두어야 한다.

# 데이터 센터

2개의 데이터 센터가 있다고 가정해보자, 아무런 장애가 없는 상황에서는 사용자의 위치에 가까운 데이터 센터로 안내된다.
이 절차를 지리적 라우팅이라고 부르며,
이를 geoDNS라고 부른다. geoDNS는 사용자의 위치에 따라 도메인 이름을 어떤 IP주소로 변환할지 결정해주는 DNS서비스이다. (이 개념은 인터넷에 navar.com을 입력할 때 어떤일이 일어나는지? 질문의 답변에 포함된다.)

`그렇다면 2개중 하나의 데이터센터가 다운된다면 어떨까? 카카오는 데이터센터가 하나였다.

- 트래픽 우회 - 다른 데이터 센터로 안내를 해주어야 한다.
- 데이터 동기화 - A 데이터 센터와 B데이터센터의 데이터가 일치하지 않을 수 있으므로, 데이터베이스를 다중화 해두어야 한다. (카카오가 이걸 안했다.)
- 테스트 및 배포 - 여러 위치에서 사전에 테스트 해봐야 한다.

데이터베이스 다중화?
데이터 베이스 다중화 방식에는 크게 2가지 방식이 있습니다.
<Actice-Active 방식>

- 클러스터를 구성하는 컴포넌트들이 동시에 가동되는 방식, 하나의 저장소를 공유함
  장점
  시스템이 다운되어 있는 시간이 짧기 때문에 시스템 전체가 정지하는 것을 방지할 수 있음
  동시에 가동하기 때문에 전체 cpu,메모리등이 증가해 성능 향상도 기대할 수 있음

단점
저장소에서 병목이 일어날 수 있어서 높은 성능향상을 기대하기 어려울 수도 있다.
Active-Active 방식을 지원 하는 데이터 DBMS가 한정적이다.
( Oracle = RAC(Real Application Cluster, DB2 = pureScale 라는 이름의 Active-Active 클러스터링이 가능하고, 다른 DBMS에서는 Active-Standby 클러스터링만 대응하고 있다.
MySQL에서는 지원해주지 않는 걸로 보임 → MySQL Cluster를 사용하는 것 같은데 InnoDB가 아니라고 함 , 아래에 작성한 Galera cluster를 솔루션으로 사용한다고함
서버를 여러대 한꺼번에 운영하므로 비용이 증가함

<Active-Standby 방식>

- 클러스터를 구성하는 컴포넌트중 Active만 사용하다가 장애가 생기면 standby가 작동하는 구성
- Cold-Standby:평소에 DB가 작동하지 않다가 Active DB에 장애 작동하는 구성
- Hot-Standby: 평소에 Standby DB가 작동되는 구성이다.
- Hot-standby는 라이선스료를 많이 지급 한다는점에서 단점이 있음
- Standby DB 서버는 일정 간격으로 Active DB에 이상이 없는지를 조사하기 위한 통신을 하고 있다. 이 통신을 'Heartbeat'라고 한다. Active DB에 장애가 발생하면 이 신호가 끊기기 때문에Standby 측은 Active가 '죽었다'는 것을 알 수 있다.

책에서 언급한 넷플릭스는 `오픈 커넥트`라는 방식을 사용하여 캐시 서버를 구축하여 더욱 빠른 스트리밍 서비스를 제공한다고 한다.
ISP의 네트워크에 캐시서버를 설치하고 회원들이 자주 시청하는 콘텐츠를 새벽 시간대에 미리 저장해두는 방식입니다.
