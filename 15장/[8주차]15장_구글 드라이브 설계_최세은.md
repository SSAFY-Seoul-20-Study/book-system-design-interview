###  파일 저장 및 동기화 서비스
- 파일 추가
- 파일 다운로드
- 여러 단말에 파일 동기화
- 파일 갱신 이력 조회
- 파일 공유
- 알림 표시 

<img src="https://user-images.githubusercontent.com/108508730/231768294-3975a387-535e-4827-9419-fdeedba541f4.png" width="700">

# 1. Amazon S3
- 클라우드 저장소의 대표적 예시 
	- 대용량의 파일은 블록으로 나눠서 저장됨
	- 블록의 해시값은 메타데이터 데이터베이스에 저장되고, 각 블록은 독립적인 객체로 클라우드 저장소에 보관 
- 1개의 파일 시스템으로 업로드 된 파일을 모두 관리하는 것은 사실상 불가능
- user_id를 기준으로 **샤딩** 하는 것도 방안이긴 하나, 서버에 장애가 생기면 데이터 손실 가능 
- Amazon S3
	- S3 : Simple Storage Service
	- 객체 저장소 서비스
	- 규모 확장성, 가용성, 보안, 성능을 제공 
	- **다중화** 지원
# 2. 동기화 문제 
- 두 명 이상의 사용자가 같은 파일이나 폴더를 동시에 업데이트하려고 하는 경우 
- 먼저 처리되는 변경은 성공한 것으로 보고, 나중에 처리되는 변경은 충돌이 발생한 것으로 표시 
- [Differential Synchronization](https://www.youtube.com/watch?v=S2Hp_1jqpY8)
> 1. 마지막 쓰기 승리 (Last Write Wins, LWW)
> 2. 버전 기반 충돌 감지
> 3. 우선순위 기반 충돌 해결
> 4. 자동 병합 알고리즘
> 5. 운영 변환(Operational Transformation, OT)
# 3. 블록 저장소 서버
- 파일 업로드와 관련된 일을 처리 
	- 파일을 블록 단위로 나누고,
	- 각 블록에 압축 알고리즘을 적용하고,
	- 암호화도 진행
- 이 중, 파일 갱신 최적화 방안에는 대표적으로 2가지가 존재하며 이를 통해 네트워크 대역폭 사용량을 절감할 수 있음
	- 델타 동기화 : 파일이 수정되면 전체 파일 대신 수정이 일어난 블록만 동기화
	- 압축 : 블록 단위로 파일을 압축
# 4.메모리  캐시의 강한 일관성
- 같은 파일이면 단말, 사용자와 관계없이 동일하게 보여야 함 
- 강한 일관성
	- 캐시에 보관된 사본과 데이터베이스에 있는 원본이 일치
	- 데이터베이스에 보관된 원본에 변경이 발생하면 캐시에 있는 사본을 무효화
- 강한 일관성을 보장하기 쉬운 RDB 사용
	- Cache Invalidation : Meta 정보가 변경되면 Invalidation을 보장하도록 구현 
	- Read-Only : 로그 및 Meta 정보는 Read-Only로 충돌 방지 
cf) 최종 일관성 : 당장은 데이터가 맞지 않아도, 데이터를 사용하는게 중요하고 결국에는 일관성을 맞출 수 있을 거라 간주
# 5. 롱 폴링 
- 클라이언트와 알림 서버는 롱 폴링용 연결을 유지
- 특정 파일에 대한 변경을 감지하면 해당 연결을 끊음
- 연결이 끊기면, 클라이언트는 파일의 최신 내역을 다운로드
- 다운로드 작업이 끝났거나, 연결 타임아웃 시간에 도달하면 롱 폴링용 연결을 복원

- 웹소켓을 사용하지 않는 이유?
	- 채팅 서비스처럼 양방향 통신이 불필요
	- 알림을 보낼 일이 많지 않으며, 알림을 보낼 때도 많은 양의 데이터를 사용하지 않음
# 6. 저장소 공간 절약
- 중복 제거
	- 중복된 파일 블록을 제거
	- 블록의 해시 값을 비교해서 중복 여부를 판단
- 지능적 백업 전략
	- 한도 설정 : 보관해야 하는 파일 버전 개수에 상한
	- 중요한 버전만 보관 
- 아카이빙 저장소
	- 몇달 혹은 수년간 이용되지 않은 데이터
	- 아마존 S3 글래시어 등 
# 7. 장애 처리
- 로드 밸런서 장애 : 부 로드밸런서를 활성화
- 블록 저장소 서버 장애 : 다른 서버가 미완료 혹은 대기 상태 작업 이어받기
- 클라우드 저장소 장애 : 다른 지역에서 파일 가져오기
- API 서버 장애 : 장애 서버 격리
- 메타데이터 캐시 장애 : 메타데이터 캐시 서버 다중화
- 메타데이터 데이터베이스 장애
	- 주 데이터베이스 서버 장애 : 부 데이터베이스 서버 중 하나를 주 데이터베이스로 변경
	- 부 데이터베이스 서버 장애 : 다른 서버가 처리하게 하고 교체 
- 알림 서비스 장애 : 사용자와의 연결 다시 생성
- 오프라인 사용자 백업 큐 장애 : 큐 다중화 

